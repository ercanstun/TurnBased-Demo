<main class="w-full h-screen overflow-hidden flex justify-center items-center bg-gray-900">
  @if (!playerStats()) {
    <app-class-selection (classSelected)="onClassSelected($event)"></app-class-selection>
  } @else {
    <!-- Scene Manager -->
    @switch (scene()) {
      @case ('exploration') {
        <app-exploration 
          [isActive]="!isInventoryOpen() && !isDungeonSelectionOpen()"
          [enemies]="mapEnemies()" 
          [interactiveObjects]="mapInteractiveObjects()"
          [startPosition]="playerMapPosition()"
          [playerStats]="effectivePlayerStats()!"
          [playerGold]="playerGold()"
          [levelUpMessage]="levelUpMessage()"
          (battleStarted)="onBattleStarted($event)" 
          (inventoryToggled)="toggleInventory()"
          (objectInteracted)="onObjectInteracted($event)"
        />
      }
      @case ('combat') {
        <app-battle
          [initialOpponents]="battleOpponents()"
          [playerStats]="effectivePlayerStats()!"
          [battleRewards]="battleRewards()"
          [isBossFight]="currentEnemy()?.isBoss === true"
          [shrineBuff]="playerStats()?.shrineBuff"
          (battleEnded)="onBattleEnded($event)">
        </app-battle>
      }
      @case ('castle') {
        <app-castle
          [playerStats]="playerStats()!"
          [effectivePlayerStats]="effectivePlayerStats()!"
          [playerGold]="playerGold()"
          (openDungeonSelection)="onOpenDungeonSelection()"
          (openInventory)="toggleInventory()"
        ></app-castle>
      }
    }
    
    <!-- Global Modals -->
    @if (isDungeonSelectionOpen()) {
      <app-dungeon-selection
        [clearedFloor]="playerStats()!.clearedDungeonFloor"
        [stamina]="playerStats()!.stamina"
        (floorSelected)="onFloorSelected($event)"
        (close)="isDungeonSelectionOpen.set(false)"
      ></app-dungeon-selection>
    }

    @if (isInventoryOpen()) {
      <app-inventory
        [playerStats]="playerStats()!"
        [effectiveStats]="effectivePlayerStats()!"
        [inventory]="playerInventory()"
        [equippedItems]="equippedItems()"
        (equipItem)="onEquipItem($event)"
        (unequipItem)="onUnequipItem($event)"
        (allocateStats)="onAllocateStats($event)"
        (close)="toggleInventory()"
      ></app-inventory>
    }
  }
</main>